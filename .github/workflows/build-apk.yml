name: Build APK

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0, 1.1, 2.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes'
        required: false
        default: 'Bug fixes and improvements'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Update version in build.gradle
        run: |
          VERSION="${{ inputs.version }}"
          # Extract numeric version only (remove any non-numeric suffixes like " (beta)")
          NUMERIC_VERSION=$(echo "$VERSION" | sed 's/[[:space:]].*//')
          
          # Parse version to create version code (e.g., 1.2 -> 10200)
          MAJOR=$(echo "$NUMERIC_VERSION" | cut -d. -f1)
          MINOR=$(echo "$NUMERIC_VERSION" | cut -d. -f2)
          PATCH=$(echo "$NUMERIC_VERSION" | cut -d. -f3 2>/dev/null || echo 0)
          
          # Ensure we have numeric values (default to 0 if empty)
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          
          echo "Version: $VERSION"
          echo "Numeric Version: $NUMERIC_VERSION"
          echo "Version Code: $VERSION_CODE"
          
          # Update build.gradle
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" app/android/app/build.gradle
          sed -i "s/versionName .*/versionName \"$VERSION\"/" app/android/app/build.gradle
          
          # Update UpdateService.ts
          sed -i "s/CURRENT_VERSION_CODE = .*/CURRENT_VERSION_CODE = $VERSION_CODE;/" app/UpdateService.ts
          sed -i "s/CURRENT_VERSION_NAME = .*/CURRENT_VERSION_NAME = '$VERSION';/" app/UpdateService.ts
      
      - name: Install dependencies
        run: |
          cd app
          npm install
      
      - name: Build Android Release APK
        run: |
          cd app/android
          chmod +x gradlew
          ./gradlew assembleRelease
      
      - name: Rename APK
        run: |
          mv app/android/app/build/outputs/apk/release/app-release.apk \
             app/android/app/build/outputs/apk/release/anna-univ-notifications-v${{ inputs.version }}.apk
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: anna-univ-notifications-v${{ inputs.version }}
          path: app/android/app/build/outputs/apk/release/anna-univ-notifications-v${{ inputs.version }}.apk
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: app/android/app/build/outputs/apk/release/anna-univ-notifications-v${{ inputs.version }}.apk
          tag_name: v${{ inputs.version }}
          name: Anna University Notifications v${{ inputs.version }}
          body: |
            # Anna University Notifications App v${{ inputs.version }}
            
            ## ðŸ“± Download & Install
            
            Download the APK below and install on your Android device.
            
            **Installation Steps:**
            1. Download `anna-univ-notifications-v${{ inputs.version }}.apk`
            2. Enable "Install from Unknown Sources" in Android settings
            3. Open the APK file to install
            4. Grant notification permissions when prompted
            
            ## ðŸŽ‰ What's New
            
            ${{ inputs.release_notes }}
            
            ## âœ¨ Features
            
            - âœ… Real-time push notifications for new Anna University announcements
            - âœ… Automatic checks every 15 minutes
            - âœ… Manual test notifications via GitHub Actions
            - âœ… Home screen widget
            - âœ… Pull to refresh
            - âœ… Offline caching
            - âœ… Direct links to official documents
            - âœ… **Automatic update notifications**
            
            ## ðŸ”” Push Notifications Setup
            
            To receive push notifications, follow the [ntfy.sh Setup Guide](https://github.com/Terrificdatabytes/anna-univ-notifications/blob/main/docs/NTFY_SETUP.md).
            
            ---
            
            **Built on:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

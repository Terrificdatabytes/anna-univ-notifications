name: Test Notifications

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message to send as push notification to mobile devices'
        required: false
        default: 'Testing Anna University notification system'
        type: string
      ntfy_topic:
        description: 'ntfy.sh topic to send notifications to (default: anna-univ-notifications)'
        required: false
        default: 'anna-univ-notifications'
        type: string
      skip_notification:
        description: 'Skip sending push notification (only test scraper)'
        required: false
        default: false
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Display test message
        run: |
          echo "================================================"
          echo "TEST MESSAGE: ${{ inputs.test_message }}"
          echo "NTFY TOPIC: ${{ inputs.ntfy_topic }}"
          echo "Skip Notification: ${{ inputs.skip_notification }}"
          echo "================================================"
          echo ""
      
      - name: Send ntfy.sh Push Notification
        if: ${{ !inputs.skip_notification }}
        env:
          NTFY_TOPIC: ${{ inputs.ntfy_topic }}
        run: |
          echo "Sending test notification to mobile devices via ntfy.sh..."
          node scripts/send-test-notification.js "${{ inputs.test_message }}"
      
      - name: Install scraper dependencies
        run: |
          cd scraper
          npm install
      
      - name: Run notification scraper
        run: |
          cd scraper
          npm start
      
      - name: Verify notification data
        run: |
          # Check if notifications.json exists and is valid JSON
          if [ ! -f data/notifications.json ]; then
            echo "ERROR: notifications.json not found"
            exit 1
          fi
          
          # Validate JSON structure
          if ! jq empty data/notifications.json 2>/dev/null; then
            echo "ERROR: Invalid JSON in notifications.json"
            exit 1
          fi
          
          # Check required fields
          if [ "$(jq 'has("notifications")' data/notifications.json)" != "true" ]; then
            echo "ERROR: Missing 'notifications' field"
            exit 1
          fi
          
          if [ "$(jq 'has("lastUpdated")' data/notifications.json)" != "true" ]; then
            echo "ERROR: Missing 'lastUpdated' field"
            exit 1
          fi
          
          if [ "$(jq 'has("count")' data/notifications.json)" != "true" ]; then
            echo "ERROR: Missing 'count' field"
            exit 1
          fi
          
          echo "✓ All validation checks passed!"
          echo "✓ Notification system is working correctly"
      
      - name: Display scraped notifications
        run: |
          echo "================================================"
          echo "SCRAPED NOTIFICATIONS:"
          echo "================================================"
          cat data/notifications.json || echo "Failed to read notifications.json"
          echo ""
          echo "================================================"
          echo "TEST COMPLETED SUCCESSFULLY"
          echo "Total notifications found: $(jq '.count' data/notifications.json 2>/dev/null || echo 'N/A')"
          echo "Last updated: $(jq -r '.lastUpdated' data/notifications.json 2>/dev/null || echo 'N/A')"
          echo "================================================"

